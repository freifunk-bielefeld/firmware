#!/usr/bin/haserl
<% echo -en "content-type: text/html\r\n\r\n" %>
<!DOCTYPE html>
<html lang="de"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>info</title>
	<link rel="stylesheet" href="/css/pure-min.css">
	<link rel="stylesheet" href="/css/side-menu.css">
	<link rel="stylesheet" href="/css/grids-responsive-min.css">
	<link rel="stylesheet" href="/css/style.css">
</head>
<body>
	<div class="header">
		<div class="home-menu pure-menu pure-menu-open pure-menu-horizontal pure-menu-fixed">
			<a class="pure-menu-heading" href="<% echo -n $(uci get -q freifunk.@settings[0].community_url) %>"><% echo -n $(uci get -q freifunk.@settings[0].community_url) | cut -d\/ -f3 %></a>
			<ul>
<%
contact="$(uci get -q freifunk.@settings[0].contact)"
if [ -n "$contact" ]; then
	echo "				<li><a href='#'>Kontakt: $contact</a></li>"
fi

geo="$(uci get -q freifunk.@settings[0].geo)"
if [ -n "$geo" ]; then
	lat="${geo%% *}" lon="${geo##* }"
	echo "				<li><a href=\"https://www.openstreetmap.org?mlat=$lat&mlon=$lon&zoom=17\">Position: ${lat:0:8}N, ${lon:0:8}E</a></li>"
fi
%>
				<li><form action="https://<% echo -n "$HTTP_HOST" %>"><button type="submit" class="pure-button">Login</button></form></li>
			</ul>
		</div>
	</div>
	<div class="header">
<%
echo "		<h1>$(uci get -q freifunk.@settings[0].name)</h1>"
%>
		<h2>Firmware Version <% echo -n $(uci get -q freifunk.@settings[0].version) %></h2>
	</div>
	<div class="content">
		<div class="pure-g" style="text-align:center;">
			<div class="pure-u-1 pure-u-md-1-3">
				<div class="blockhead"></div>
				<h2>Nachbarknoten</h2>
				<h3><% echo -n $(cat /sys/kernel/debug/batman_adv/bat0/originators | grep '^[0-9a-f]' | cut -b 37-53 | sort | uniq | wc -l 2> /dev/null) %></h3>
			</div>
			<div class="pure-u-1 pure-u-md-1-3">
				<div class="blockhead"></div>
				<h2>Alle Knoten</h2>
				<h3><% echo -n $((`cat /sys/kernel/debug/batman_adv/bat0/transtable_global | grep '^ [^ ]' | cut -b 39-55 | sort | uniq | wc -l 2> /dev/null`+1)) %></h3>
			</div>
			<div class="pure-u-1 pure-u-md-1-3">
				<div class="blockhead"></div>
				<h2>Lokale Clients</h2>
				<h3><% echo -n $(cat /sys/kernel/debug/batman_adv/bat0/transtable_local 2> /dev/null | grep -c 'W') %></h3>
			</div>
		</div>
	</div>

<%
ula_addr()
{
	local prefix=$1 mac=$2 a=""

	# translate to local administered mac
	a=${mac%%:*} #cut out first hex
	a=$((0x$a ^ 2)) #invert second least significant bit
	a=$(printf '%02x\n' $a) #convert back to hex
	mac="$a:${mac#*:}" #reassemble mac

	mac=${mac//:/} # remove ':'
	mac=${mac:0:6}fffe${mac:6:6} # insert ffee
	mac=$(echo $mac | sed 's/..../&:/g') # insert ':'

	# assemble IPv6 address
	echo "${prefix%%::*}:${mac%?}"
}

ula_prefix="$(uci get network.globals.ula_prefix)"

echo '	<div class="content">'
echo '		<h2 class="content-subhead">Nachbarknoten:</h2>'
echo '		<ul>'

macs="$(cat /sys/kernel/debug/batman_adv/bat0/neighbors | awk '{if(NR>2 && NF==3) print($2)}')"
if [ -n "$macs" ]; then
	i=1
	for mac in $macs; do
		echo "			<li><h3><a href=\"http://[$(ula_addr $ula_prefix $mac)]\">Nachbarknoten $i</a></h3></li>"
		i=$((i+1))
	done
else
	echo '			<li><h3>Keine Nachbarn gefunden.</h3></li>'
fi

echo '		</ul>'
echo '	</div>'


max=$(uci get -q freifunk.@settings[0].service_display_max)
if [ -n "$max" -a "$max" != "0" ]; then
	addr_prefix="${ula_prefix%%::*}:"

	echo '	<div class="content">'
	echo '		<h2 class="content-subhead">Liste lokaler Angebote im Freifunk-Netz:</h2>'
	echo '		<ul>'
	link_list=$(
		printf "$(alfred -r 91 | head -$max)" | awk -F'["\\]+' -v addr_prefix="$addr_prefix" '{ if($5 == "link" && match($7, "^[][ #[:alnum:]_\/.:]{1,128}$") && $9 == "label" && match($11, "^[][ [:alnum:]_\/.:]{1,32}$") && match($7, addr_prefix "|\.ff[a-z]{0,3}")) printf("			<li><h3><a href=\"%s\">%s</a></h3></li>\n", $7, $11) }'
	)
	[ -n "$link_list" ] && echo "$link_list" || echo '		<li><h3>Keine Angebote gefunden.</h3></li>'
	echo '		</ul>'
	echo '	</div>'
fi
%>
</body>
</html>

